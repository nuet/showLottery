<?php
 namespace Fuzhi\Model; use Think\Model; class CategoryModel extends Model{ protected $_validate = array( array('name', 'require', '标识不能为空', self::EXISTS_VALIDATE, 'regex', self::MODEL_BOTH), array('name', '', '标识已经存在', self::VALUE_VALIDATE, 'unique', self::MODEL_BOTH), array('title', 'require', '名称不能为空', self::MUST_VALIDATE , 'regex', self::MODEL_BOTH), ); protected $_auto = array( array('model', 'arr2str', self::MODEL_BOTH, 'function'), array('model', null, self::MODEL_BOTH, 'ignore'), array('extend', 'json_encode', self::MODEL_BOTH, 'function'), array('extend', null, self::MODEL_BOTH, 'ignore'), array('create_time', NOW_TIME, self::MODEL_INSERT), array('update_time', NOW_TIME, self::MODEL_BOTH), array('status', '1', self::MODEL_BOTH), ); public function info($id, $field = true){ $map = array(); if(is_numeric($id)){ $map['id'] = $id; } else { $map['name'] = $id; } return $this->field($field)->where($map)->find(); } public function getTree($id = 0, $field = true){ if($id){ $info = $this->info($id); $id = $info['id']; } $map = array('status' => 1); $list = $this->field($field)->where($map)->order('sort')->select(); $list = list_to_tree($list, $pk = 'id', $pid = 'pid', $child = '_', $root = $id); if(isset($info)){ $info['_'] = $list; } else { $info = $list; } return $info; } public function getSameLevel($id, $field = true){ $info = $this->info($id, 'pid'); $map = array('pid' => $info['pid'], 'status' => 1); return $this->field($field)->where($map)->order('sort')->select(); } public function update(){ $data = $this->create(); if(!$data){ return false; } return empty($data['id']) ? $this->add() : $this->save(); } public function getChildrenId($cate){ $field = 'id,name,pid,title,link_id'; $category = D('Category')->getTree($cate, $field); $ids = array(); foreach ($category['_'] as $key => $value) { $ids[] = $value['id']; } return implode(',', $ids); } protected function _after_find(&$data, $options){ if(!empty($data['model'])){ $data['model'] = explode(',', $data['model']); } if(!empty($data['type'])){ $data['type'] = explode(',', $data['type']); } if(!empty($data['reply_model'])){ $data['reply_model'] = explode(',', $data['reply_model']); } if(!empty($data['reply_type'])){ $data['reply_type'] = explode(',', $data['reply_type']); } if(!empty($data['extend'])){ $data['extend'] = json_decode($data['extend'], true); } } } 